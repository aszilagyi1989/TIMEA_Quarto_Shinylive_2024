---
title: ""
format: html
filters: 
 - shinylive
resources: 
 - shinylive-sw.js
 - timea_mutatok_2024.csv
 - timea_megyek_2024.csv
 - megye_pbi.zip
 - megye_pbi.shp
 - megye_pbi.cpg
 - megye_pbi.dbf
 - megye_pbi.shx
---

```{shinylive-r}
#| standalone: true
#| viewerHeight: 800
library("shiny")
library("dplyr")
library("sf")

 ui <- fluidPage(
   titlePanel("Térképes Interaktív Megjelenítő Alkalmazás"),
   sidebarLayout(
     sidebarPanel(
       sliderInput(
         inputId = "bins",
         label = "Number of bins:",
         min = 1,
        max = 50,
         value = 30
       ),
       uiOutput("focsop"),
       uiOutput("mutato"),
       uiOutput("year"),
       hr(),
       uiOutput("search"),
       sliderInput("alpha",
                   "Fedettség:",
                   min = 20,
                   max = 100,
                   value = 80)
     ),
     mainPanel(
       plotOutput(outputId = "distPlot")
     )
   )
 )


 server <- function(input, output) {

   output$focsop <- renderUI({
     
      telepules_ATTRIBUTES <- read.csv("https://raw.githubusercontent.com/aszilagyi1989/TIMEA_Quarto_Shinylive_2024/refs/heads/main/CSV/TIMEA_Mutatok_2024.csv", sep = ";", row.names = NULL)
  telepules_DATA <- read.csv("https://raw.githubusercontent.com/aszilagyi1989/TIMEA_Quarto_Shinylive_2024/refs/heads/main/CSV/TIMEA_Megyek_2024.csv", sep = ";", row.names = NULL)
 telepules_DATA$NEV <- gsub(" vármegye", "", telepules_DATA$NEV)
 
telepules_MAP <- sf::read_sf("/vsizip//vsicurl/https://github.com/aszilagyi1989/TIMEA_Quarto_Shinylive_2024/raw/refs/heads/main/JSon/megye_pbi.zip")
telepules_MAP$Megyenév <- gsub("Csongrád", "Csongrád-Csanád", telepules_MAP$Megyenév)

telepules_DATA %>% left_join(telepules_ATTRIBUTES, by = c("M_KOD" = "MUTATO_KOD")) %>% select("NEV", "VALUE", "M_KOD", "VON_IDO", "MUTATO_FOCSOP_MEGNEV", "MUTATO_MEGNEV") -> telepules_DATA
telepules_MAP %>% left_join(telepules_DATA, by = c("Megyenév" = "NEV")) %>% select("Megyenév", "geometry", "VALUE", "M_KOD", "VON_IDO", "MUTATO_FOCSOP_MEGNEV", "MUTATO_MEGNEV") -> telepules_MAP
telepules_MAP$VALUE <- gsub(",", ".", telepules_MAP$VALUE)
telepules_MAP$VALUE <- as.numeric(telepules_MAP$VALUE)

     selectInput(
       "focsop",
       "Főcsoport",
       choices = unique(telepules_DATA$MUTATO_FOCSOP_MEGNEV),
       selected = unique(telepules_DATA$MUTATO_FOCSOP_MEGNEV)[1]
       )

   })

   output$mutato <- renderUI({
     
      telepules_ATTRIBUTES <- read.csv("https://raw.githubusercontent.com/aszilagyi1989/TIMEA_Quarto_Shinylive_2024/refs/heads/main/CSV/TIMEA_Mutatok_2024.csv", sep = ";", row.names = NULL)
  telepules_DATA <- read.csv("https://raw.githubusercontent.com/aszilagyi1989/TIMEA_Quarto_Shinylive_2024/refs/heads/main/CSV/TIMEA_Megyek_2024.csv", sep = ";", row.names = NULL)
 telepules_DATA$NEV <- gsub(" vármegye", "", telepules_DATA$NEV)
telepules_MAP <- st_read("/vsizip//vsicurl/https://github.com/aszilagyi1989/TIMEA_Quarto_Shinylive_2024/raw/refs/heads/main/JSon/megye_pbi.shp")
telepules_MAP$Megyenév <- gsub("Csongrád", "Csongrád-Csanád", telepules_MAP$Megyenév)

telepules_DATA %>% left_join(telepules_ATTRIBUTES, by = c("M_KOD" = "MUTATO_KOD")) %>% select("NEV", "VALUE", "M_KOD", "VON_IDO", "MUTATO_FOCSOP_MEGNEV", "MUTATO_MEGNEV") -> telepules_DATA
telepules_MAP %>% left_join(telepules_DATA, by = c("Megyenév" = "NEV")) %>% select("Megyenév", "geometry", "VALUE", "M_KOD", "VON_IDO", "MUTATO_FOCSOP_MEGNEV", "MUTATO_MEGNEV") -> telepules_MAP
telepules_MAP$VALUE <- gsub(",", ".", telepules_MAP$VALUE)
telepules_MAP$VALUE <- as.numeric(telepules_MAP$VALUE)
    
    selectInput(
      "mutato", 
      "Mutató",
      choices = unique(telepules_DATA[telepules_DATA$MUTATO_FOCSOP_MEGNEV == input$focsop, "MUTATO_MEGNEV"]), 
      selected = unique(telepules_DATA[telepules_DATA$MUTATO_FOCSOP_MEGNEV == input$focsop, "MUTATO_MEGNEV"])[1])
    
  })
   
   output$search <- renderUI({
    
    selectInput(
      "search", 
      "Keresés",
      choices = c("Magyarország", unique(telepules_DATA[telepules_DATA$MUTATO_FOCSOP_MEGNEV == input$focsop, "NEV"])), 
      selected = "Magyarország")
    
  })
  
  output$year <- renderUI({
    
    selectInput(
      "year", 
      "Év",
      choices = unique(telepules_DATA$VON_IDO), 
      selected = "2024")
    
  })



   subsetted <- reactive({

     # req(input$focsop)
     # req(input$mutato)
     # req(input$search)
     # req(input$year)
     # req(input$color)

     if (input$search != "Magyarország"){

       telepules_MAP %>% filter(MUTATO_FOCSOP_MEGNEV %in% input$focsop & MUTATO_MEGNEV %in% input$mutato & VON_IDO %in% input$year & Megyenév %in% input$search)

     }else{

       telepules_MAP %>% filter(MUTATO_FOCSOP_MEGNEV %in% input$focsop & MUTATO_MEGNEV %in% input$mutato & VON_IDO %in% input$year)

     }

   })



   # output$distPlot <- renderPlot({
   # 
   #   x <- faithful$waiting
   #   bins <- seq(min(x), max(x), length.out = input$bins + 1)
   #   hist(x,
   #     breaks = bins, col = "#75AADB", border = "white",
   #     xlab = "Waiting time to next eruption (in mins)",
   #     main = "Histogram of waiting times"
   #   )
   # 
   # })

}

shinyApp(ui = ui, server = server)
```